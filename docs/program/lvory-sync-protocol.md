# Lvory 同步协议使用手册

> **⚠️ 草案状态**  
> 本文档当前处于草案阶段，协议规范和功能特性可能会在正式发布前发生变更。  
> 请在生产环境使用前确认最新版本。

## 目录

1. [协议简介](#1-协议简介)
2. [配置文件结构](#2-配置文件结构)
3. [节点匹配机制](#3-节点匹配机制)
4. [工作流程](#4-工作流程)
5. [冲突解决策略](#5-冲突解决策略)
6. [自动更新机制](#6-自动更新机制)
7. [错误处理与恢复](#7-错误处理与恢复)
8. [配置验证](#8-配置验证)
9. [实际应用场景](#9-实际应用场景)
10. [使用建议](#10-使用建议)

## 1. 协议简介

Lvory 同步协议是一套专门用于 Lvory 应用的智能配置管理系统，让您可以轻松管理复杂的代理配置。它的核心功能是将一个主配置文件与多个节点订阅源自动合并，通过智能匹配算法保持节点信息的同步更新。

### 1.1 主要功能

- **主配置管理**：使用一个主配置文件管理路由规则、DNS设置等基础架构
- **多源节点池**：从多个订阅源获取节点信息，自动补充到主配置
- **智能匹配**：通过节点名称等标识符自动匹配和更新节点
- **自动同步**：定时检查各个配置源的更新，保持配置最新
- **冲突处理**：当不同源有相同节点时，智能选择最优配置

## 2. 配置文件结构

### 2.1 总体架构

Lvory 同步协议使用一个专门的配置文件来管理所有的同步设置。这个配置文件包含以下几个主要部分：

- **基础设置**：协议版本和同步模式
- **主配置源**：指定主要的配置文件来源
- **副节点源**：定义多个节点订阅源
- **合并策略**：设置如何处理冲突和重复
- **输出配置**：指定最终配置的保存位置

### 2.2 基础设置

#### version (协议版本)
- **类型**：字符串
- **必填**：是
- **说明**：标识当前使用的协议版本，确保配置文件的兼容性
- **格式**：主版本号.次版本号（如："1.0"）
- **示例**：`"1.0"`

#### sync_mode (同步模式)
- **类型**：字符串
- **必填**：是
- **可选值**：
  - `auto`：自动同步，根据设定的时间间隔自动更新所有配置源
  - `manual`：手动同步，仅在用户手动触发时更新
  - `scheduled`：定时同步，按照预设的时间表执行更新操作
- **默认值**：`auto`
- **示例**：`"auto"`

### 2.3 主配置文件设置

主配置文件是整个代理配置的基础架构，包含路由规则、DNS设置、入站配置等核心内容。

#### source (配置来源)
- **类型**：字符串
- **必填**：是
- **可选值**：
  - `local`：使用本地文件作为主配置
  - `url`：从远程URL获取主配置
- **示例**：`"local"` 或 `"url"`

#### path (本地文件路径)
- **类型**：字符串
- **必填**：当source为"local"时必填
- **说明**：指定本地配置文件的完整路径
- **示例**：`"./configs/master.json"`

#### url (远程配置地址)
- **类型**：字符串
- **必填**：当source为"url"时必填
- **说明**：指定远程配置文件的URL地址
- **格式**：必须以http://或https://开头
- **示例**：`"https://example.com/master.json"`

#### update_interval (更新间隔)
- **类型**：字符串
- **必填**：否
- **说明**：设置检查主配置更新的频率
- **格式**：数字+单位
  - 小时：`6h`、`12h`、`24h`
  - 天数：`1d`、`7d`、`30d`
- **默认值**：不自动更新
- **示例**：`"24h"`

### 2.4 副节点源配置

副节点源是提供节点信息的订阅源，可以配置多个源以获得更丰富的节点选择。

#### name (节点源名称)
- **类型**：字符串
- **必填**：是
- **说明**：为节点源设置一个易识别的名称，用于日志记录和状态显示
- **限制**：同一配置中的名称必须唯一
- **示例**：`"高级节点池"`

#### source (来源类型)
- **类型**：字符串
- **必填**：是
- **可选值**：
  - `local`：本地文件
  - `url`：远程订阅
- **示例**：`"url"`

#### url (订阅地址)
- **类型**：字符串
- **必填**：当source为"url"时必填
- **说明**：节点订阅的URL地址
- **格式**：必须以http://或https://开头
- **示例**：`"https://example.com/nodes.json"`

#### path (本地文件路径)
- **类型**：字符串
- **必填**：当source为"local"时必填
- **说明**：本地节点文件的路径
- **示例**：`"./nodes/backup.json"`

#### update_interval (更新间隔)
- **类型**：字符串
- **必填**：否
- **说明**：该源的检查更新频率
- **格式**：同主配置的update_interval
- **建议值**：免费源4-6小时，付费源6-12小时
- **示例**：`"6h"`

#### priority (优先级)
- **类型**：数字
- **必填**：否
- **说明**：数字越小优先级越高，用于冲突解决时的选择
- **范围**：1-999
- **默认值**：99
- **示例**：`1`

#### enabled (启用状态)
- **类型**：布尔值
- **必填**：否
- **说明**：是否启用该节点源
- **默认值**：`true`
- **示例**：`true`

### 2.5 节点过滤规则

为了获得更精确的节点选择，可以为每个副节点源设置过滤规则。过滤规则是可选的，如果不设置则接受该源的所有节点。

#### include_tags (包含标签)
- **类型**：字符串数组
- **必填**：否
- **说明**：只保留带有指定标签的节点
- **示例**：`["premium", "fast", "stable"]`

#### exclude_tags (排除标签)
- **类型**：字符串数组
- **必填**：否
- **说明**：移除带有指定标签的节点
- **示例**：`["expired", "slow", "test"]`

#### include_types (包含类型)
- **类型**：字符串数组
- **必填**：否
- **说明**：只保留指定协议类型的节点
- **可选值**：`shadowsocks`、`vmess`、`trojan`、`vless`、`hysteria`等
- **示例**：`["shadowsocks", "vmess", "trojan"]`

#### exclude_types (排除类型)
- **类型**：字符串数组
- **必填**：否
- **说明**：移除指定协议类型的节点
- **示例**：`["http", "socks"]`

#### region_filter (地区过滤)
- **类型**：字符串数组
- **必填**：否
- **说明**：根据节点所在地区进行筛选
- **格式**：使用ISO 3166-1 alpha-2国家代码
- **示例**：`["CN", "HK", "JP", "US"]`

### 2.6 合并策略

当多个源有相同或冲突的节点时，合并策略决定如何处理。

#### node_conflict_resolution (节点冲突解决)
- **类型**：字符串
- **必填**：否
- **可选值**：
  - `priority`：按照源的优先级选择（数字小的优先）
  - `latest`：选择最新更新的版本
  - `master_priority`：主配置中的节点始终优先
- **默认值**：`priority`
- **示例**：`"priority"`

#### preserve_master_structure (保持主配置结构)
- **类型**：布尔值
- **必填**：否
- **说明**：确保主配置的基础架构（路由规则、DNS等）不被副源影响
- **默认值**：`true`
- **示例**：`true`

#### auto_tag_generation (自动标签生成)
- **类型**：布尔值
- **必填**：否
- **说明**：为合并的节点自动生成标识标签，避免命名冲突
- **默认值**：`false`
- **示例**：`true`

#### duplicate_handling (重复节点处理)
- **类型**：字符串
- **必填**：否
- **可选值**：
  - `skip`：跳过重复的节点，保持原有节点
  - `replace`：用新节点替换旧节点
  - `rename`：重命名新节点避免冲突
- **默认值**：`replace`
- **示例**：`"replace"`

### 2.7 输出配置

#### path (输出路径)
- **类型**：字符串
- **必填**：是
- **说明**：合并后配置文件的保存路径
- **示例**：`"./merged.json"`

#### backup_original (备份原文件)
- **类型**：布尔值
- **必填**：否
- **说明**：在覆盖前是否备份原始配置文件
- **默认值**：`true`
- **示例**：`true`

#### validate_config (验证配置)
- **类型**：布尔值
- **必填**：否
- **说明**：是否在保存前验证生成的配置文件
- **默认值**：`true`
- **示例**：`true`

## 3. 节点匹配机制

### 3.1 匹配原理

Lvory 同步协议通过智能匹配算法自动识别主配置和副节点源中的相同节点，实现配置的无缝合并。

### 3.2 匹配标识符

系统使用多种标识符来判断节点是否相同：

**主要标识符**：
- **节点名称（tag）**：最主要的匹配依据，精确匹配节点名称
- **服务器地址+端口**：通过服务器IP/域名和端口的组合进行匹配
- **协议特定标识**：如VMess协议的UUID、Shadowsocks的密码等

### 3.3 匹配策略

匹配过程按照以下优先级顺序进行：

1. **精确名称匹配**：节点名称完全相同时，确认为同一节点
2. **服务器匹配**：服务器地址和端口都相同时，判定为同一节点
3. **协议匹配**：针对特定协议使用其独有标识符进行匹配
4. **模糊匹配**：通过相似度算法进行智能判断

### 3.4 匹配置信度

系统为每种匹配方式分配不同的置信度：
- 精确名称匹配：100% 置信度
- 服务器+端口匹配：90% 置信度  
- 协议特定匹配：80% 置信度
- 模糊匹配：60% 置信度

只有达到设定置信度阈值的匹配才会被采用。

## 4. 工作流程

### 4.1 同步过程概览

Lvory 同步协议的执行过程分为五个主要阶段，确保配置的安全性和准确性。

### 4.2 初始化准备

**配置检查**：
- 验证同步配置文件的语法正确性
- 检查各个配置源的可访问性
- 确认权限和文件路径的有效性

**环境准备**：
- 创建必要的工作目录
- 准备备份文件夹
- 初始化日志记录

### 4.3 数据收集

**主配置获取**：
- 根据配置的源类型（本地/远程）获取主配置文件
- 验证主配置的结构完整性
- 提取现有的节点信息

**副源数据获取**：
- 并行获取所有启用的副节点源数据
- 检查每个源的更新时间戳
- 记录获取状态和可能的错误

### 4.4 数据处理

**节点提取**：
- 从各个配置源中提取节点信息
- 为每个节点标记来源和优先级
- 应用配置的过滤规则

**智能匹配**：
- 使用匹配算法识别相同节点
- 计算匹配置信度
- 生成匹配报告

### 4.5 配置合并

**冲突处理**：
- 根据设定的策略解决节点冲突
- 处理重复节点
- 生成合并决策日志

**配置组装**：
- 保持主配置的基础结构
- 更新匹配的节点信息
- 添加新发现的节点

### 4.6 结果输出

**质量保证**：
- 验证最终配置的语法正确性
- 检查配置的逻辑完整性
- 确保所有必要字段都存在

**安全保存**：
- 备份原始配置文件
- 保存合并后的新配置
- 更新同步元数据和日志

## 5. 冲突解决策略

### 5.1 冲突类型识别

在配置合并过程中，可能遇到以下几种冲突情况：

**节点名称冲突**：
不同源的节点使用了相同的名称，但可能指向不同的服务器或使用不同的配置参数。

**服务器配置冲突**：
同一个服务器的节点在不同源中有不同的配置参数，如端口号、加密方式等。

**协议类型冲突**：
同一标识的节点在不同源中被标记为不同的协议类型。

### 5.2 解决策略详解

#### 5.2.1 优先级策略

当发生冲突时，系统会选择来自优先级最高源的节点配置。

**适用场景**：
- 有明确的配置源可信度排序
- 需要确保特定源的配置始终优先

**工作方式**：
系统会比较所有冲突节点的源优先级，选择数字最小（优先级最高）的配置。

#### 5.2.2 最新更新策略

选择最近更新的节点配置，确保使用最新的连接信息。

**适用场景**：
- 需要保持节点信息的时效性
- 各源的更新频率不同

**工作方式**：
系统会比较各个冲突节点的最后更新时间，选择时间戳最新的配置。

#### 5.2.3 主配置优先策略

始终保持主配置文件中的节点设置，忽略副源的相同节点。

**适用场景**：
- 主配置已经过精心调试
- 不希望副源影响已有的稳定配置

**工作方式**：
当检测到冲突时，系统会保留主配置中的节点，丢弃副源的相同节点。

## 6. 自动更新机制

### 6.1 定时更新系统

Lvory 同步协议支持灵活的自动更新机制，确保配置始终保持最新状态。

**独立定时器**：
- 每个配置源都有独立的更新定时器
- 可以为不同源设置不同的更新频率
- 主配置和副源的更新周期互不影响

**智能调度**：
- 避免多个源同时更新造成资源冲突
- 支持错峰更新时间设置
- 自动处理网络异常时的重试机制

### 6.2 更新频率设置

**时间格式**：
- 小时单位：6h, 12h, 24h
- 天数单位：1d, 7d, 30d
- 禁用更新：设置为 0 或不设置

**推荐频率**：
- 主配置：12-24小时（变化较少）
- 免费节点源：4-6小时（变化频繁）
- 付费节点源：6-12小时（相对稳定）

### 6.3 增量更新优化

**变化检测**：
- 通过文件哈希值快速检测配置是否有变化
- 只有确实发生变化时才执行完整的合并过程
- 记录上次同步时间戳避免重复处理

**局部更新**：
- 支持仅更新有变化的配置源
- 保持其他未变化源的配置不变
- 减少不必要的网络请求和处理时间

### 6.4 更新状态监控

**实时状态**：
- 显示每个配置源的最后更新时间
- 提供更新成功/失败的状态指示
- 记录详细的更新日志

**错误处理**：
- 网络超时时自动重试
- 配置源不可达时的降级处理
- 保持系统在部分源失效时仍能正常工作

## 7. 错误处理与恢复

### 7.1 常见错误类型

在使用过程中可能遇到以下错误情况：

**配置错误**：
- 同步配置文件语法错误
- 必填字段缺失或格式不正确
- 配置源路径或URL无效

**网络问题**：
- 远程配置源无法访问
- 网络连接超时
- 服务器返回错误状态码

**合并冲突**：
- 无法解决的节点冲突
- 配置结构不兼容
- 循环依赖或引用错误

**文件操作**：
- 权限不足无法写入文件
- 磁盘空间不足
- 备份创建失败

### 7.2 恢复策略

**自动回滚**：
当合并过程中发生严重错误时，系统会自动恢复到最后一个已知的正常配置状态。

**部分同步**：
如果某个配置源出现问题，系统会跳过该源，继续处理其他可用的源，确保服务不中断。

**降级模式**：
在遇到严重错误时，系统会切换到安全模式，停止自动更新，防止进一步的配置损坏。

**智能重试**：
对于临时性错误（如网络超时），系统会自动重试，重试间隔会逐渐增加以避免频繁请求。

### 7.3 错误预防

**配置验证**：
在执行同步前，系统会全面验证配置文件的正确性，及早发现潜在问题。

**备份保护**：
每次合并前都会自动创建配置备份，确保数据安全。

**测试模式**：
支持干运行模式，可以预览合并结果而不实际修改配置文件。

## 8. 配置验证

### 8.1 验证层次

Lvory 同步协议采用多层验证机制确保配置的正确性和安全性。

**语法层验证**：
- 检查JSON格式是否正确
- 验证必填字段是否存在
- 确认字段类型和格式符合规范

**逻辑层验证**：
- 检查配置源的可访问性
- 验证优先级设置的合理性
- 确认过滤规则的语法正确

**兼容性验证**：
- 检查主配置与副源的结构兼容性
- 验证节点协议类型的支持情况
- 确认合并策略的可执行性

### 8.2 验证检查项

**基础配置检查**：
- 协议版本是否受支持
- 同步模式设置是否有效
- 输出路径是否可写

**配置源检查**：
- 本地文件路径是否存在
- 远程URL是否可访问
- 更新间隔格式是否正确

**副源配置检查**：
- 节点源名称是否唯一
- 优先级数值是否有冲突
- 过滤规则语法是否正确

**合并策略检查**：
- 冲突解决策略是否合理
- 重复处理方式是否有效
- 输出配置是否完整

### 8.3 验证时机

**配置加载时**：
在读取同步配置文件时进行初步验证，确保基本格式正确。

**同步执行前**：
在开始同步操作前进行全面验证，检查所有配置源的可用性。

**合并完成后**：
在生成最终配置后进行结果验证，确保输出配置的正确性。

## 9. 实际应用场景

### 9.1 场景一：个人用户多源管理

**使用背景**：
个人用户需要管理多个节点订阅源，希望将不同来源的节点统一到一个配置文件中。

**配置特点**：
- 使用本地主配置文件管理基础设置
- 添加2-3个节点订阅源
- 设置简单的优先级策略
- 启用自动备份

**推荐设置**：
- 同步模式：auto（自动）
- 主配置更新：24小时
- 副源更新：6-12小时
- 冲突策略：priority（优先级）

### 9.2 场景二：团队共享配置

**使用背景**：
团队需要共享一套基础配置，同时允许个人添加额外的节点源。

**配置特点**：
- 主配置来自团队共享的远程URL
- 个人可添加本地或私人订阅源
- 保持团队配置的权威性
- 定期同步团队更新

**推荐设置**：
- 同步模式：scheduled（定时）
- 主配置更新：12小时
- 个人源更新：自定义
- 冲突策略：master_priority（主配置优先）

### 9.3 场景三：高可用性配置

**使用背景**：
对网络稳定性要求很高，需要多个备用节点源确保服务连续性。

**配置特点**：
- 配置多个高质量节点源作为备份
- 设置智能故障转移机制
- 启用实时监控和快速更新
- 优化节点过滤规则

**推荐设置**：
- 同步模式：auto（自动）
- 主配置更新：6小时
- 备用源更新：4小时
- 冲突策略：latest（最新）

### 9.4 配置文件示例

**基础配置模板**：
```yaml
lvory_sync:
  version: "1.0"
  sync_mode: "auto"
  master_config:
    source: "local"
    path: "./master.json"
    update_interval: "24h"
  secondary_sources:
    - name: "主要节点源"
      source: "url"
      url: "https://example.com/nodes.json"
      update_interval: "12h"
      priority: 1
      enabled: true
      filter:
        include_types: ["shadowsocks", "vmess", "trojan"]
        exclude_tags: ["expired", "test"]
  merge_strategy:
    node_conflict_resolution: "priority"
    preserve_master_structure: true
    auto_tag_generation: false
    duplicate_handling: "replace"
  output:
    path: "./merged.json"
    backup_original: true
    validate_config: true
```
